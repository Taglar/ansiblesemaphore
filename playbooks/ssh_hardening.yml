---
- name: SSH Hardening und Benutzeranlage
  hosts: LinuxUbuntu
  become: true
  become_method: sudo

  vars:
    juergen_user: juergen
    juergen_group: juergen
    sudoers_file: "/etc/sudoers.d/90-juergen"
    sshd_config_path: "/etc/ssh/sshd_config"

  tasks:

    - name: Stelle sicher, dass das Paket sudo vorhanden ist
      apt:
        name: sudo
        state: present
        update_cache: yes

    - name: Benutzer "{{ juergen_user }}" anlegen
      user:
        name: "{{ juergen_user }}"
        password: "{{ juergen_password | password_hash('sha512') }}"
        shell: /bin/bash
        create_home: yes
        groups: sudo
        append: yes

    - name: Authorized_keys Verzeichnis anlegen
      file:
        path: "/home/{{ juergen_user }}/.ssh"
        state: directory
        owner: "{{ juergen_user }}"
        group: "{{ juergen_group }}"
        mode: '0700'

    - name: SSH Public Key hinterlegen
      copy:
        dest: "/home/{{ juergen_user }}/.ssh/authorized_keys"
        content: "{{ SSH_PUBLIC_KEY }}"
        owner: "{{ juergen_user }}"
        group: "{{ juergen_group }}"
        mode: '0600'

    - name: Sudo-Rechte für juergen hinzufügen (ohne Passwort)
      copy:
        dest: "{{ sudoers_file }}"
        content: "{{ juergen_user }} ALL=(ALL) NOPASSWD:ALL"
        owner: root
        group: root
        mode: '0440'

    - name: Root-Login und Passwort-Authentifizierung deaktivieren
      lineinfile:
        path: "{{ sshd_config_path }}"
        regexp: '^#?PermitRootLogin'
        line: 'PermitRootLogin no'
        state: present
        backrefs: yes

    - name: Passwort-Authentifizierung deaktivieren
      lineinfile:
        path: "{{ sshd_config_path }}"
        regexp: '^#?PasswordAuthentication'
        line: 'PasswordAuthentication no'
        state: present
        backrefs: yes

    - name: SSH-Dienst neu starten
      service:
        name: ssh
        state: restarted

    - name: Prüfen, ob SSH-Dienst aktiv ist
      shell: systemctl is-active ssh
      register: ssh_status
      changed_when: false

    - name: Ergebnis anzeigen
      debug:
        msg:
          - "SSH Hardening abgeschlossen."
          - "Benutzer '{{ juergen_user }}' wurde angelegt und mit SSH-Key versehen."
          - "Root-Login ist deaktiviert."
          - "SSH-Dienststatus: {{ ssh_status.stdout }}"
