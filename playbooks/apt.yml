---
- name: APT Update & Upgrade mit Backup und Logging
  hosts: all
  become: true
  become_method: sudo
  become_user: root
  gather_facts: true

  vars:
    backup_root: "/var/backups"

  pre_tasks:
    - name: Generiere globalen Zeitstempel
      delegate_to: localhost
      run_once: true
      set_fact:
        global_backup_date: "{{ lookup('pipe', 'date +%Y-%m-%d_%H%M%S') }}"

    - name: Verteile globalen Zeitstempel an alle Hosts
      set_fact:
        backup_date: "{{ hostvars['localhost'].global_backup_date }}"
        backup_dir: "{{ backup_root }}/apt_config_{{ hostvars['localhost'].global_backup_date }}"
        diff_log: "{{ backup_root }}/apt_config_{{ hostvars['localhost'].global_backup_date }}/apt_diff.log"
        new_files_log: "{{ backup_root }}/apt_config_{{ hostvars['localhost'].global_backup_date }}/new_config_files.log"

  tasks:

    # ------------------------------------------------------------
    # PrÃ¼fen und ggf. Rechte fÃ¼r /var/backups anpassen
    # ------------------------------------------------------------
    - name: PrÃ¼fe Schreibrechte auf /var/backups
      stat:
        path: /var/backups
      register: backups_stat

    - name: Rechte fÃ¼r /var/backups anpassen (falls nÃ¶tig)
      file:
        path: /var/backups
        owner: root
        group: root
        mode: '0755'
      when: backups_stat.stat.exists and backups_stat.stat.mode|int != 493
      become: true

    # ------------------------------------------------------------
    # Backup- und Log-Verzeichnisse anlegen
    # ------------------------------------------------------------
    - name: Verzeichnisse fÃ¼r Backups/Logs anlegen
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ backup_dir }}"
        - "/var/log"

    # ------------------------------------------------------------
    # Header-Dateien anlegen (nur auf bestimmtem Host)
    # ------------------------------------------------------------
    - name: Header fÃ¼r Diff-Log anlegen
      copy:
        dest: "{{ diff_log }}"
        content: |
          === APT KonfigurationsÃ¤nderungen ===
          Datum: {{ lookup('pipe', 'date') }}
          ====================================
      when: inventory_hostname == '81.169.250.132'

    - name: Header fÃ¼r Liste der neuen Konfigurationsdateien anlegen
      copy:
        dest: "{{ new_files_log }}"
        content: |
          === Neue Konfigurationsdateien ===
          Datum: {{ lookup('pipe', 'date') }}
          ==================================
      when: inventory_hostname == '81.169.250.132'

    # ------------------------------------------------------------
    # Paketquellen und Upgrades
    # ------------------------------------------------------------
    - name: Paketquellen aktualisieren (apt update)
      apt:
        update_cache: yes
      register: update_result

    - name: APT-Update-Ergebnis anzeigen
      debug:
        var: update_result.stdout_lines
      when: update_result is defined

    - name: FÃ¼hre APT Upgrade durch (aktualisiere installierte Pakete)
      apt:
        upgrade: dist
        autoremove: yes
        autoclean: yes
      register: upgrade_result

    - name: APT-Upgrade-Ergebnis anzeigen
      debug:
        msg: "{{ upgrade_result.stdout_lines | default(['Keine Ã„nderungen notwendig.']) }}"
      when: upgrade_result is defined

    # ------------------------------------------------------------
    # Neue oder geÃ¤nderte Konfigurationsdateien sichern
    # ------------------------------------------------------------
    - name: Suche nach neuen oder geÃ¤nderten Konfigurationsdateien
      find:
        paths: /etc
        patterns: "*.dpkg-dist"
      register: new_config_files

    - name: Neue Dateien sichern
      copy:
        src: "{{ item.path }}"
        dest: "{{ backup_dir }}/"
        remote_src: true
      loop: "{{ new_config_files.files }}"
      when: new_config_files.matched > 0

    - name: PrÃ¼fe, ob Originaldateien existieren
      stat:
        path: "{{ item.path | regex_replace('.dpkg-dist$', '') }}"
      loop: "{{ new_config_files.files }}"
      register: original_files
      when: new_config_files.matched > 0

    - name: Originaldateien sichern (falls vorhanden)
      copy:
        src: "{{ item.stat.path }}"
        dest: "{{ backup_dir }}/"
        remote_src: true
      loop: "{{ original_files.results }}"
      when:
        - item.stat.exists is defined
        - item.stat.exists

    # ------------------------------------------------------------
    # Zusammenfassung
    # ------------------------------------------------------------
    - name: Zusammenfassung anzeigen
      debug:
        msg:
          - "âœ… Paketquellen aktualisiert"
          - "âœ… Installierte Pakete aktualisiert"
          - "âœ… Alte Pakete entfernt und System bereinigt"
          - "âœ… Backups und Logs gespeichert unter: {{ backup_dir }}"
          - "ðŸš€ APT-Update & Upgrade abgeschlossen"
