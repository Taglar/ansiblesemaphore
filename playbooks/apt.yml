---
- name: APT Update & Upgrade mit Preflight, Locking, Backup, Cleanup und Logging
  hosts: LinuxUbuntu
  become: true
  gather_facts: true

  vars:
    backup_root: "/var/backups"
    log_dir: "/var/log/ansible"
    lock_file: "/var/run/apt_update.lock"

  pre_tasks:
    - name: Preflight – Prüfe Ansible Become
      assert:
        that:
          - ansible_user_id is defined
        fail_msg: "Ansible Benutzer nicht ermittelbar"

    - name: Preflight – Prüfe effektive Root-Rechte
      assert:
        that:
          - ansible_effective_user_id == 0
        fail_msg: "Playbook läuft nicht mit Root-Rechten (become fehlgeschlagen)"

    - name: Preflight – Prüfe ob Lock existiert
      stat:
        path: "{{ lock_file }}"
      register: lock_stat

    - name: Preflight – Abbruch bei aktivem Lock
      fail:
        msg: "Ein APT-Update läuft bereits"
      when: lock_stat.stat.exists

    - name: Preflight – Prüfe ob /var/log existiert
      stat:
        path: /var/log
      register: log_stat

    - name: Preflight – Abbruch wenn /var/log fehlt
      fail:
        msg: "/var/log existiert nicht – Logging zwingend erforderlich"
      when: not log_stat.stat.exists

    - name: Preflight – Prüfe ob APT gesperrt ist
      stat:
        path: /var/lib/dpkg/lock-frontend
      register: dpkg_lock

    - name: Preflight – Abbruch bei aktivem APT-Lock
      fail:
        msg: "APT ist aktuell gesperrt (dpkg lock)"
      when: dpkg_lock.stat.exists

    - name: Lock setzen
      file:
        path: "{{ lock_file }}"
        state: touch
        owner: root
        group: root
        mode: '0644'

    - name: Zeitstempel setzen
      run_once: true
      delegate_to: localhost
      set_fact:
        backup_date: "{{ lookup('pipe', 'date +%Y%m%dT%H%M%S') }}"

    - name: Variablen setzen
      set_fact:
        backup_base_dir: "{{ backup_root }}/apt_config_{{ backup_date }}"
        backup_dir: "{{ backup_root }}/apt_config_{{ backup_date }}/{{ inventory_hostname }}"
        log_file: "{{ log_dir }}/apt_update_{{ backup_date }}_{{ inventory_hostname }}.log"

  tasks:
    - name: Stelle sicher, dass /var/log/ansible existiert
      file:
        path: "{{ log_dir }}"
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Initialisiere Logdatei
      copy:
        dest: "{{ log_file }}"
        content: |
          Host: {{ inventory_hostname }}
          Start: {{ ansible_date_time.iso8601 }}
        owner: root
        group: root
        mode: '0644'

    - name: Stelle sicher, dass apt_config Root-Verzeichnis existiert
      file:
        path: "{{ backup_base_dir }}"
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Backup-Verzeichnis für Host anlegen
      file:
        path: "{{ backup_dir }}"
        state: directory
        mode: '0755'

    - name: Paketquellen aktualisieren
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: System upgraden
      apt:
        upgrade: dist
        autoremove: yes
        autoclean: yes

    - name: Prüfe, ob Reboot erforderlich ist
      stat:
        path: /var/run/reboot-required
      register: reboot_check

    - name: Reboot-Status setzen
      set_fact:
        reboot_required: "{{ reboot_check.stat.exists | default(false) }}"

    - name: Logge Reboot-Status
      lineinfile:
        path: "{{ log_file }}"
        line: "Reboot erforderlich: {{ reboot_required }}"

    - name: Suche nach .dpkg-dist Dateien
      find:
        paths: /etc
        patterns: "*.dpkg-dist"
      register: dpkg_dist_files

    - name: .dpkg-dist Dateien sichern
      copy:
        src: "{{ item.path }}"
        dest: "{{ backup_dir }}/"
        remote_src: true
      loop: "{{ dpkg_dist_files.files }}"
      when: dpkg_dist_files.matched > 0

    - name: Originaldateien sichern
      copy:
        src: "{{ item.path | regex_replace('\\.dpkg-dist$', '') }}"
        dest: "{{ backup_dir }}/"
        remote_src: true
      loop: "{{ dpkg_dist_files.files }}"
      when:
        - dpkg_dist_files.matched > 0
        - lookup('ansible.builtin.fileglob', item.path | regex_replace('\\.dpkg-dist$', '')) | length > 0

    - name: Prüfe, ob Backup-Verzeichnis Dateien enthält
      find:
        paths: "{{ backup_dir }}"
        file_type: file
      register: backup_content

    - name: Entferne leeres Host-Backup-Verzeichnis
      file:
        path: "{{ backup_dir }}"
        state: absent
      when: backup_content.matched == 0

    - name: Prüfe, ob Root-Backup-Verzeichnis leer ist
      find:
        paths: "{{ backup_base_dir }}"
        file_type: directory
      register: root_backup_content

    - name: Entferne leeres Root-Backup-Verzeichnis
      file:
        path: "{{ backup_base_dir }}"
        state: absent
      when: root_backup_content.matched == 0

    - name: Finalisiere Logdatei
      lineinfile:
        path: "{{ log_file }}"
        line: "Ende: {{ ansible_date_time.iso8601 }}"

  post_tasks:
    - name: Lock entfernen
      file:
        path: "{{ lock_file }}"
        state: absent

    - name: Zusammenfassung
      debug:
        msg:
          - "APT-Upgrade abgeschlossen auf {{ inventory_hostname }}"
          - "{{ 'Neustart erforderlich' if reboot_required else 'Kein Neustart notwendig' }}"
