---
- name: APT Update & Upgrade mit Backup und Cleanup
  hosts: LinuxUbuntu
  become: true
  gather_facts: true

  vars:
    backup_root: "/var/backups"

  pre_tasks:
    - name: Globalen Zeitstempel setzen
      run_once: true
      set_fact:
        backup_date: "{{ ansible_date_time.iso8601_basic_short }}"

    - name: Backup-Variablen setzen
      set_fact:
        backup_dir: "{{ backup_root }}/apt_config_{{ backup_date }}/{{ inventory_hostname }}"

  tasks:

    # ------------------------------------------------------------
    # Backup-Verzeichnis vorbereiten
    # ------------------------------------------------------------
    - name: Stelle sicher, dass /var/backups existiert
      file:
        path: /var/backups
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Backup-Verzeichnis f체r Host anlegen
      file:
        path: "{{ backup_dir }}"
        state: directory
        mode: '0755'

    # ------------------------------------------------------------
    # APT Update & Upgrade
    # ------------------------------------------------------------
    - name: Paketquellen aktualisieren
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: System upgraden
      apt:
        upgrade: dist
        autoremove: yes
        autoclean: yes

    # ------------------------------------------------------------
    # Reboot-Check
    # ------------------------------------------------------------
    - name: Pr체fe, ob Reboot erforderlich ist
      stat:
        path: /var/run/reboot-required
      register: reboot_check

    - name: Reboot-Status setzen
      set_fact:
        reboot_required: "{{ reboot_check.stat.exists | default(false) }}"

    # ------------------------------------------------------------
    # dpkg-dist Dateien sichern
    # ------------------------------------------------------------
    - name: Suche nach .dpkg-dist Dateien
      find:
        paths: /etc
        patterns: "*.dpkg-dist"
      register: dpkg_dist_files

    - name: .dpkg-dist Dateien sichern
      copy:
        src: "{{ item.path }}"
        dest: "{{ backup_dir }}/"
        remote_src: true
      loop: "{{ dpkg_dist_files.files }}"
      when: dpkg_dist_files.matched > 0

    - name: Originaldateien sichern (falls vorhanden)
      copy:
        src: "{{ item.path | regex_replace('\\.dpkg-dist$', '') }}"
        dest: "{{ backup_dir }}/"
        remote_src: true
      loop: "{{ dpkg_dist_files.files }}"
      when:
        - dpkg_dist_files.matched > 0
        - lookup('ansible.builtin.fileglob', item.path | regex_replace('\\.dpkg-dist$', '')) | length > 0

    # ------------------------------------------------------------
    # Leere Backup-Verzeichnisse entfernen
    # ------------------------------------------------------------
    - name: Pr체fe, ob Backup-Verzeichnis Dateien enth채lt
      find:
        paths: "{{ backup_dir }}"
        file_type: file
      register: backup_content

    - name: Entferne leeres Backup-Verzeichnis
      file:
        path: "{{ backup_dir }}"
        state: absent
      when: backup_content.matched == 0

    # ------------------------------------------------------------
    # Zusammenfassung
    # ------------------------------------------------------------
    - name: Zusammenfassung
      debug:
        msg:
          - "APT-Upgrade abgeschlossen auf {{ inventory_hostname }}"
          - "{{ 'Neustart erforderlich' if reboot_required else 'Kein Neustart notwendig' }}"
